export const config = { runtime: 'edge' };

const KNOWLEDGE_BASE = `
## è¿°èŒæ±‡æŠ¥ PPT
å¸¸è§å†…å®¹ç»“æž„ï¼šæ€»-åˆ†-æ€»ç»“æž„ã€‚å¼€åœºç®€ä»‹æ±‡æŠ¥ä¸»é¢˜å’Œç›®çš„ï¼ŒåŒ…æ‹¬"æˆ‘æ˜¯è°"ï¼ˆå§“åèŒä½ï¼‰åŠæ±‡æŠ¥æ—¶é—´èŒƒå›´ã€‚ä¸»ä½“éƒ¨åˆ†è¯¦è¿°å·¥ä½œå†…å®¹å’Œå…³é”®æˆæžœï¼ŒæŒ‰èŒè´£æˆ–é¡¹ç›®æ¨¡å—åˆ†æ¿å—æ±‡æŠ¥ï¼Œåˆ—ä¸¾å…·ä½“ä¸šç»©æ•°æ®ã€æ¡ˆä¾‹æˆæžœå’Œç»éªŒæ•™è®­ã€‚ç»“å°¾æ€»ç»“æ•´ä½“ä¸šç»©ï¼Œæå‡ºæœªæ¥è®¡åˆ’æˆ–æ”¹è¿›æ–¹å‘ã€‚
è§†è§‰é£Žæ ¼ï¼šæ­£å¼ä¸“ä¸šï¼Œé‡è§†æ•°æ®å›¾è¡¨ï¼ˆæŸ±çŠ¶å›¾ã€æŠ˜çº¿å›¾ã€é¥¼å›¾ï¼‰ï¼Œç‰ˆé¢ç®€æ´å¤§æ–¹ï¼Œæ¯é¡µä¸å®œä¿¡æ¯è¿‡è½½ã€‚
è¯­è¨€é£Žæ ¼ï¼šç¬¬ä¸€äººç§°å™è¿°ï¼ˆå¦‚"æˆ‘å®Œæˆäº†â€¦"ï¼‰ï¼Œç®€æ´æ˜Žäº†ã€å®¢è§‚ä¸“ä¸šï¼Œçªå‡ºäº‹å®žå’Œæ•°æ®ã€‚

## å•†ä¸šæ¼”è®² PPT
å¸¸è§å†…å®¹ç»“æž„ï¼šä¾§é‡è®²å¥½"æ•…äº‹"ã€‚å¼€åœºç”¨ä¸€ä¸ªç—›ç‚¹æˆ–å¼•é¢˜åˆ‡å…¥ã€‚ä¸»ä½“æŒ‰ç…§é—®é¢˜-æ–¹æ¡ˆ-ä¼˜åŠ¿-æ¡ˆä¾‹çš„é€»è¾‘å±•å¼€ã€‚ç»“å°¾æ€»ç»“å…³é”®ä¿¡æ¯ï¼Œç»™å‡ºå·å¬ï¼ˆCall to Actionï¼‰ã€‚
è§†è§‰é£Žæ ¼ï¼šä¸“ä¸šæ€§å’Œå¸å¼•åŠ›çš„å¹³è¡¡ï¼Œé€‚å½“åŠ å…¥ä¸°å¯Œçš„å›¾ç¤ºå’Œå›¾è¡¨ï¼ˆä¿¡æ¯å›¾ã€æµç¨‹å›¾ã€å¯¹æ¯”å›¾è¡¨ï¼‰ï¼Œä¸€é¡µä¸€é‡ç‚¹ï¼Œæœç»å¤§æ®µæ–‡å­—ã€‚
è¯­è¨€é£Žæ ¼ï¼šç®€æ´ã€æœ‰åŠ›ä¸”å¯Œæœ‰è¯´æœåŠ›ï¼Œå¸¸ä»¥ç¬¬ä¸€äººç§°å¤æ•°ï¼ˆ"æˆ‘ä»¬"ï¼‰æˆ–ç¬¬äºŒäººç§°ï¼ˆ"æ‚¨"ï¼‰ï¼Œå¯Œæœ‰æ¿€æƒ…å’Œæ•…äº‹æ€§ã€‚

## æŠ•èžèµ„è·¯æ¼” PPT
å¸¸è§å†…å®¹ç»“æž„ï¼šéµå¾ªç»å…¸åé¡µæ³•åˆ™ã€‚å¸¸è§é¡ºåºï¼šå…¬å¸/é¡¹ç›®æ¦‚è¿°ã€å¸‚åœºç—›ç‚¹ã€è§£å†³æ–¹æ¡ˆã€å•†ä¸šæ¨¡å¼ã€å¸‚åœºå‰æ™¯ã€ç«žäº‰åˆ†æžã€æ ¸å¿ƒä¼˜åŠ¿ã€å›¢é˜Ÿä»‹ç»ã€è´¢åŠ¡åŠé‡Œç¨‹ç¢‘ã€èžèµ„éœ€æ±‚ã€‚å¿…é¡»é«˜åº¦å‡ç»ƒã€‚
è§†è§‰é£Žæ ¼ï¼šç®€æ´ç›´è§‚å’Œè§†è§‰å†²å‡»åŠ›ï¼Œå…¨ç¯‡ä¸è¶…è¿‡12-15é¡µï¼Œæ¯é¡µåªä¼ è¾¾å•ä¸€ä¸»é¢˜ï¼Œå¤§é‡è¿ç”¨å›¾è¡¨å’Œå›¾ç¤ºï¼Œä»¥å›¾èƒœäºŽå­—ã€‚
è¯­è¨€é£Žæ ¼ï¼šç®€æ˜Žæ‰¼è¦ã€å¯Œæœ‰æ¿€æƒ…ï¼Œæ–‡å­—é€šå¸¸ç”¨çŸ­å¥æˆ–å…³é”®è¯ç½—åˆ—ã€‚ç”¨"äººè¯"è®²æ¸…å•†ä¸šæ¨¡å¼ã€‚

## åŸ¹è®­è¯¾ä»¶ PPT
å¸¸è§å†…å®¹ç»“æž„ï¼šå¯¼å…¥-å±•å¼€-å°ç»“çš„å¾ªçŽ¯ã€‚å¼€å¤´æœ‰è¯¾ç¨‹ç®€ä»‹/ç›®æ ‡ã€‚æ­£å¼å†…å®¹æŒ‰ç« èŠ‚æˆ–æ¨¡å—åˆ’åˆ†ï¼Œæ¯ä¸ªæ¨¡å—å†…éƒ¨éµå¾ªç†è®ºè®²è§£->æ¡ˆä¾‹/ç¤ºä¾‹->ç»ƒä¹ /è®¨è®ºçš„æµç¨‹ã€‚ç»“å°¾åŒ…å«æ€»ç»“å›žé¡¾å’ŒQ&Aç­”ç–‘ã€‚
è§†è§‰é£Žæ ¼ï¼šä¸“ä¸šæ¸…æ™°ï¼Œä¹Ÿå¯æ´»æ³¼äº²å’Œã€‚å¼ºè°ƒå†…å®¹é‡ç‚¹å¤„å¯ä»¥ç”¨å›¾æ ‡ã€ç¤ºæ„å›¾æˆ–æµç¨‹å›¾å¸®åŠ©ç†è§£ã€‚å›¾æ–‡å¹¶èŒ‚ã€‚
è¯­è¨€é£Žæ ¼ï¼šæ•™å­¦åŒ–å’Œäº’åŠ¨å¼ã€‚å¸¸é‡‡ç”¨ç¬¬äºŒäººç§°æˆ–ç¥ˆä½¿å¥ï¼ˆä¾‹å¦‚"è¯·æ€è€ƒâ€¦"ï¼‰ï¼Œä¸“ä¸šæœ¯è¯­ä¼šè¿›è¡Œè§£é‡Šã€‚PPTä¸Šæ–‡å­—å¤šç”¨è¦ç‚¹å¼åˆ—ä¸¾ã€‚

## å­¦æœ¯æ±‡æŠ¥ PPT
å¸¸è§å†…å®¹ç»“æž„ï¼šç´§æ‰£è®ºæ–‡æˆ–ç ”ç©¶çš„ç»“æž„ï¼Œé€»è¾‘ç¼œå¯†ã€‚æ¡†æž¶ï¼šæ ‡é¢˜é¡µ->ç ”ç©¶èƒŒæ™¯ä¸Žæ„ä¹‰->ç ”ç©¶æ–¹æ³•->ç ”ç©¶ç»“æžœ->è®¨è®ºä¸Žç»“è®º->è‡´è°¢ã€‚
è§†è§‰é£Žæ ¼ï¼šç®€æ´æ¸…æ™°ã€çªå‡ºä¿¡æ¯ï¼Œæµ…è‰²èƒŒæ™¯+æ·±è‰²æ–‡å­—ï¼ˆç™½åº•é»‘å­—ï¼‰ï¼Œå›¾è¡¨æ˜¯é‡å¿ƒã€‚
è¯­è¨€é£Žæ ¼ï¼šä¸“ä¸šä¸¥è°¨ä¸”ç®€æ˜Žï¼Œå¤šä¸ºè®ºæ–‡å¼çš„çŸ­è¯­æˆ–å¥å­æè¦ï¼ŒæŽªè¾žå®¢è§‚ä¸­ç«‹ã€‚

## é¡¹ç›®æ€»ç»“ PPT
å¸¸è§å†…å®¹ç»“æž„ï¼šå›´ç»•é¡¹ç›®ç”Ÿå‘½å‘¨æœŸã€‚é¡¹ç›®èƒŒæ™¯ä¸Žç›®æ ‡->è¿‡ç¨‹ä¸Žäº§å‡º->ç»“æžœä¸Žç»©æ•ˆ->ç»éªŒæ•™è®­ä¸Žæ”¹è¿›ã€‚
è§†è§‰é£Žæ ¼ï¼šç®€æ´ä¸“ä¸šï¼Œå¤§é‡ä½¿ç”¨æ ‡é¢˜å’Œå°æ ‡é¢˜ï¼Œè¿ç”¨å›¾è¡¨å’Œå›¾å½¢å‘ˆçŽ°æ•°æ®å’Œè¿›åº¦ï¼ˆå¦‚ç”˜ç‰¹å›¾ã€æŸ±çŠ¶å›¾ï¼‰ã€‚
è¯­è¨€é£Žæ ¼ï¼šæ­£å¼å®¢è§‚ï¼Œçªå‡ºäº‹å®žå’Œæ•°æ®ï¼Œå†…å®¹å¤šä»¥è¦ç‚¹å½¢å¼å‘ˆçŽ°ã€‚

## ç«žè˜æ¼”è®² PPT
å¸¸è§å†…å®¹ç»“æž„ï¼šå›´ç»•ä¸ªäººä¼˜åŠ¿å’Œå²—ä½å¥‘åˆåº¦ã€‚å››ä¸ªæ ¸å¿ƒéƒ¨åˆ†ï¼šä¸ªäººç®€ä»‹->å²—ä½ç†è§£->ä¼˜åŠ¿åŠ£åŠ¿åˆ†æž->å·¥ä½œè®¾æƒ³ã€‚
è§†è§‰é£Žæ ¼ï¼šç®€æ´ç¾Žè§‚ä¸”å¯Œæœ‰ä¸ªäººç‰¹è‰²ï¼Œåº„é‡ä½†æœ‰è¾¨è¯†åº¦ã€‚
è¯­è¨€é£Žæ ¼ï¼šæ¿€æƒ…è‡ªä¿¡ã€æ¡ç†æ¸…æ™°ï¼Œä½¿ç”¨ç¬¬ä¸€äººç§°ï¼ˆ"æˆ‘"ï¼‰ï¼Œè¯­è¨€ç”ŸåŠ¨ï¼Œè¿ç”¨å®žä¾‹å’Œå…·ä½“ä¸šç»©æ•…äº‹æ”¯æ’‘è§‚ç‚¹ã€‚
`;

const buildPrompt = (style, content, urls, userPrompt) => `
ä½ æ˜¯ä¸€ä¸ªé¡¶çº§çš„"PPTå†…å®¹æˆ˜ç•¥å®¶"å’Œ"é¡¹ç›®æŒ‡æŒ¥å®˜"ã€‚

## æ ¸å¿ƒçŸ¥è¯†åº“
${KNOWLEDGE_BASE}

## ä½ çš„ä»»åŠ¡

ç”¨æˆ·é€‰æ‹©çš„PPTåœºæ™¯æ˜¯ï¼šã€${style}ã€‘
ç”¨æˆ·æä¾›çš„åŽŸå§‹ææ–™å¦‚ä¸‹ï¼š

${content ? `### ç”¨æˆ·æä¾›çš„æ–‡å­—å†…å®¹ï¼š\n${content}\n` : ''}
${urls ? `### ç”¨æˆ·æä¾›çš„å‚è€ƒèµ„æ–™é“¾æŽ¥ï¼š\n${urls}\n` : ''}
${userPrompt ? `### ç”¨æˆ·çš„é¢å¤–éœ€æ±‚ï¼š\n${userPrompt}\n` : ''}

è¯·æŒ‰ä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤å·¥ä½œï¼š

### ç¬¬ä¸€æ­¥ï¼šè¾“å‡ºä½ çš„åˆ†æžè¿‡ç¨‹
è¯·ç”¨è‡ªç„¶è¯­è¨€è¯¦ç»†é˜è¿°ä½ çš„åˆ†æžå’Œæ€è€ƒè¿‡ç¨‹ï¼ŒåŒ…æ‹¬ï¼š
1. ðŸŽ¯ **åœºæ™¯è¯†åˆ«**ï¼šåŒ¹é…åˆ°äº†å“ªä¸ªåœºæ™¯ï¼Œè¯¥åœºæ™¯æœ‰ä»€ä¹ˆç‰¹ç‚¹
2. ðŸ“‹ **å†…å®¹åˆ†æž**ï¼šä»ŽåŽŸå§‹ææ–™ä¸­æå–äº†å“ªäº›å…³é”®ä¿¡æ¯ã€æ•°æ®å’Œè§‚ç‚¹
3. ðŸ—ï¸ **ç»“æž„è§„åˆ’**ï¼šä½ è®¡åˆ’é‡‡ç”¨ä»€ä¹ˆç»“æž„æ¥ç»„ç»‡PPTï¼Œä¸ºä»€ä¹ˆ
4. âœï¸ **è¯­è¨€é£Žæ ¼**ï¼šå°†é‡‡ç”¨ä»€ä¹ˆè¯­è¨€é£Žæ ¼ï¼Œä¸ºä»€ä¹ˆé€‚åˆè¿™ä¸ªåœºæ™¯
5. ðŸŽ¨ **è§†è§‰å»ºè®®**ï¼šæŽ¨èçš„é…è‰²å’Œè§†è§‰é£Žæ ¼

è¯·ç¡®ä¿åˆ†æžè¿‡ç¨‹è¯¦ç»†ã€æœ‰æ´žå¯ŸåŠ›ï¼Œè®©ç”¨æˆ·èƒ½å¤Ÿç†è§£ä½ çš„è®¾è®¡æ€è·¯ã€‚

### ç¬¬äºŒæ­¥ï¼šè¾“å‡ºç»“æž„åŒ–å¤§çº²
åœ¨åˆ†æžè¿‡ç¨‹ä¹‹åŽï¼Œè¯·è¾“å‡ºä¸€ä¸ªJSONä»£ç å—ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

\`\`\`json
{
  "title": "PPTä¸»æ ‡é¢˜",
  "style": "${style}",
  "audience": "ç›®æ ‡å—ä¼—",
  "theme": {
    "primary": "#1e293b",
    "accent": "#3b82f6",
    "background": "#ffffff"
  },
  "slides": [
    {
      "type": "title",
      "headline": "ä¸»æ ‡é¢˜",
      "subheadline": "å‰¯æ ‡é¢˜"
    },
    {
      "type": "agenda",
      "headline": "è®®ç¨‹æ ‡é¢˜",
      "bullets": ["è®®ç¨‹é¡¹1", "è®®ç¨‹é¡¹2"]
    },
    {
      "type": "content",
      "headline": "å†…å®¹é¡µæ ‡é¢˜",
      "bullets": ["è¦ç‚¹1", "è¦ç‚¹2", "è¦ç‚¹3"]
    },
    {
      "type": "data",
      "headline": "æ•°æ®å±•ç¤ºæ ‡é¢˜",
      "metrics": [
        { "label": "æŒ‡æ ‡å", "value": "æ•°å€¼", "description": "è¯´æ˜Ž" }
      ]
    },
    {
      "type": "timeline",
      "headline": "æ—¶é—´çº¿æ ‡é¢˜",
      "items": [
        { "phase": "é˜¶æ®µ", "title": "æ ‡é¢˜", "description": "æè¿°" }
      ]
    },
    {
      "type": "two-column",
      "headline": "å¯¹æ¯”æ ‡é¢˜",
      "leftTitle": "å·¦åˆ—",
      "leftBullets": ["å·¦1"],
      "rightTitle": "å³åˆ—",
      "rightBullets": ["å³1"]
    },
    {
      "type": "closing",
      "headline": "ç»“æŸè¯­",
      "subheadline": "è¡ŒåŠ¨å·å¬",
      "bullets": ["ä¸‹ä¸€æ­¥1"]
    }
  ]
}
\`\`\`

slide typeå¯é€‰å€¼ï¼štitle, agenda, content, data, timeline, two-column, closing

ä¸¥æ ¼éµå®ˆçŸ¥è¯†åº“ä¸­ã€${style}ã€‘çš„å†…å®¹ç»“æž„ã€è§†è§‰é£Žæ ¼å’Œè¯­è¨€é£Žæ ¼è§„åˆ™ã€‚
æ ¹æ®å†…å®¹é‡åˆç†æŽ§åˆ¶é¡µæ•°ï¼ˆä¸€èˆ¬8-15é¡µï¼‰ã€‚æ¯é¡µbulletsæŽ§åˆ¶åœ¨3-5æ¡ã€‚
`;

export default async function handler(request) {
  if (request.method === 'OPTIONS') {
    return new Response(null, { status: 200, headers: { 'Access-Control-Allow-Origin': '*', 'Access-Control-Allow-Methods': 'POST', 'Access-Control-Allow-Headers': 'Content-Type' } });
  }

  if (request.method !== 'POST') {
    return new Response(JSON.stringify({ error: 'Method not allowed' }), { status: 405, headers: { 'Content-Type': 'application/json' } });
  }

  const apiKey = process.env.GEMINI_API_KEY;
  if (!apiKey) {
    return new Response(JSON.stringify({ error: 'API Key not configured' }), { status: 500, headers: { 'Content-Type': 'application/json' } });
  }

  try {
    const { prompt, style, content, urls } = await request.json();
    const fullPrompt = buildPrompt(style || 'å•†ä¸šæ¼”è®²', content || '', urls || '', prompt || '');

    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ role: 'user', parts: [{ text: fullPrompt }] }],
          generationConfig: { temperature: 0.7, maxOutputTokens: 8192 }
        }),
      }
    );

    const data = await response.json();
    if (data.error) {
      return new Response(JSON.stringify({ error: data.error.message }), { status: 400, headers: { 'Content-Type': 'application/json' } });
    }

    const text = data.candidates?.[0]?.content?.parts?.map(p => p.text || '').join('') || '';

    // Split thinking and JSON
    const jsonBlockMatch = text.match(/```json\s*([\s\S]*?)\s*```/);
    let thinking = text;
    let outline = null;

    if (jsonBlockMatch) {
      thinking = text.substring(0, text.indexOf('```json')).trim();
      try {
        outline = JSON.parse(jsonBlockMatch[1]);
      } catch (e) {
        const fallback = text.match(/\{[\s\S]*\}/);
        if (fallback) outline = JSON.parse(fallback[0]);
      }
    } else {
      const fallback = text.match(/\{[\s\S]*\}/);
      if (fallback) {
        thinking = text.substring(0, text.indexOf(fallback[0])).trim();
        outline = JSON.parse(fallback[0]);
      }
    }

    return new Response(JSON.stringify({ success: true, thinking, outline }), {
      status: 200,
      headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },
    });

  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), { status: 500, headers: { 'Content-Type': 'application/json' } });
  }
}
